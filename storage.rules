rules_version = '2';

/**
 * Firebase Storage Security Rules for POCHOCLO
 *
 * These rules control who can read/write files in Firebase Storage.
 *
 * STRUCTURE:
 * profile-images/
 *   └── {userId}/
 *         └── avatar.jpg
 *
 * SECURITY:
 * - Users can only upload to their own folder
 * - Any authenticated user can view profile images
 * - Max file size: 5MB
 * - Only image files allowed
 */
service firebase.storage {
  match /b/{bucket}/o {

    // =======================================================================
    // PROFILE IMAGES
    // =======================================================================
    // Path: profile-images/{userId}/{filename}
    //
    // This is where user profile pictures are stored.
    // Each user has their own folder identified by their Firebase Auth UID.
    //
    match /profile-images/{userId}/{allPaths=**} {

      // READ: Any authenticated user can view profile images
      // WHY? Profile pictures are meant to be visible to other users
      allow read: if request.auth != null;

      // WRITE: Users can only modify their own profile image
      // CONDITIONS:
      // 1. Must be authenticated
      // 2. UID must match the folder they're writing to
      // 3. File must be under 5MB (prevents abuse)
      // 4. Must be an image file (validates content-type header)
      allow write: if request.auth != null
                   && request.auth.uid == userId
                   && request.resource.size < 5 * 1024 * 1024
                   && request.resource.contentType.matches('image/.*');
    }

    // =======================================================================
    // DENY ALL OTHER PATHS
    // =======================================================================
    // Security best practice: explicitly deny everything not allowed above.
    // This prevents accidental exposure if new paths are added without rules.
    //
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
